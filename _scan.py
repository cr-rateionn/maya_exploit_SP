# -*- coding: utf-8 -*-
import os
import sys
import pathlib
import socket
import datetime

import scanExploitMel
from google import sendGspread

sys.dont_write_bytecode = True
sys.stdout.flush()

if __name__ == "__main__":
    exploit = []
    mayaDocuments = pathlib.Path(os.getenv("USERPROFILE")).joinpath("Documents", "maya")
    exploit.extend(scanExploitMel.scanInstallDirMel(mayaDocuments.as_posix(), "**/userSetup.mel"))
    exploit.extend(scanExploitMel.scanInstallDirMel(r"C:\Program Files\Autodesk", "**/plug-ins/animImportExport.pres.mel"))


    """
    # 指定したGoogle Spread Sheetに簡易セキュリティチェック状況を送信する機能を搭載しております。
    # 監視するユーザー数が多い場合に非常に有効かと思いますので、利用する場合は下記のプログラムを動作するように設定いただければと思います。

    # 参考
    # https://qiita.com/koyopro/items/d8d56f69f863f07e9378


    # 辞書の各keyが指定したエクセルの1行目の一致した列に入力されます。
    info = {
        "username": os.getenv("USERNAME"),
        "host": socket.gethostname(),
        # "ip":socket.gethostbyname(socket.gethostname()),
        "result": len(exploit),
        "files": "\n".join(exploit),
        "datetime": datetime.datetime.now().strftime(
                        "%Y-%m-%d %H:%M:%S.%f"
                    )
    }

    # サンプルスプレッドシート
    # このシートを複製してお使いください。
    # https://docs.google.com/spreadsheets/d/1txnBJoQ8cA3NG5JMt1UuEet5US71ESCt1MdpsYo6DIA/edit?usp=sharing
    sheet_key = "1txnBJoQ8cA3NG5JMt1UuEet5US71ESCt1MdpsYo6DIA"

    # サービスアカウントのライアントIDを発行した際に生成したjsonファイルを指定してください。
    json_file = pathlib.Path(__file__).parent.joinpath("coyote-sheets-6a73477efa5a.json")

    sendGspread.update_status_sheet(info, "host", sheet_key , json_file)

    """


    with open("chack.log", "w") as f:
        if exploit:
            f.write("There may be a malicious program.")
            print("There may be a malicious program.")
        else:
            f.write("A quick check didn't detect any problems.")
            print("A quick check didn't detect any problems.")

    sys.exit(len(exploit))

